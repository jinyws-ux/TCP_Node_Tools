<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>æ—¥å¿—åˆ†ææŠ¥å‘Š</title>
    <meta charset="utf-8">
    <script>
        // å…¼å®¹ URLSearchParams (é€‚é…IE/æ—§æµè§ˆå™¨)
        if (!window.URLSearchParams) {
            window.URLSearchParams = function(search) {
                const params = {};
                search = search || window.location.search.slice(1);
                search.split('&').forEach(pair => {
                    const [k, v] = pair.split('=').map(decodeURIComponent);
                    if (k) params[k] = v || '';
                });
                this.get = (k) => params[k] || null;
            };
        }

        // æŠ¥å‘Šæ•°æ®å°†é€šè¿‡APIåŠ¨æ€åŠ è½½
        var reportData = null;
        var selectedMsgTypes = new Set();
        var reportId = null; // å…¨å±€æŠ¥å‘ŠIDå˜é‡
        var API_BASE = function() {
            try {
                var params = new URLSearchParams(window.location.search || '');
                var queryBase = (params.get('api_base') || '').trim();
                if (queryBase) return queryBase.replace(/\/$/, '');
            } catch (_) {}
            // å§‹ç»ˆä½¿ç”¨å½“å‰é¡µé¢çš„originï¼Œç¡®ä¿æŒ‡å‘æœåŠ¡å™¨ç«¯
            return window.location.origin;
        }();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // ä»URLè·¯å¾„ä¸­è·å–æŠ¥å‘ŠID
            var pathParts = window.location.pathname.split('/').filter(function(item) {
                return Boolean(item);
            }); // è¿‡æ»¤ç©ºå­—ç¬¦ä¸²
            reportId = pathParts[pathParts.length - 1];
            
            // å¦‚æœURLè·¯å¾„ä¸­æ²¡æœ‰æŠ¥å‘ŠIDï¼Œå°è¯•ä»URLæŸ¥è¯¢å‚æ•°è·å–
            if (!reportId || reportId === '') {
                var params = new URLSearchParams(window.location.search || '');
                reportId = params.get('report_id') || params.get('id');
            }
            
            // ç¡®ä¿reportIdæ˜¯æœ‰æ•ˆçš„ï¼Œä¸æ˜¯undefinedæˆ–null
            if (!reportId || reportId === '' || reportId === 'undefined' || reportId === 'null') {
                showError('ç¼ºå°‘æŠ¥å‘ŠID');
                return;
            }
            
            // åŠ è½½æŠ¥å‘Šæ•°æ®
            loadReportData(reportId).then(function() {
                // åˆå§‹åŒ–é¡µé¢
                initPage();
            }).catch(function(error) {
                showError('åˆå§‹åŒ–é¡µé¢å¤±è´¥: ' + error.message);
            });
        });

        // åŠ è½½æŠ¥å‘Šæ•°æ®
        async function loadReportData(reportIdParam) {
            try {
                const response = await fetch(`${API_BASE}/api/report-details/${encodeURIComponent(reportIdParam)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'åŠ è½½æŠ¥å‘Šæ•°æ®å¤±è´¥');
                }
                reportData = data.report_data;
                // ç¡®ä¿reportDataæœ‰nameå±æ€§
                document.title = `${reportData?.name || 'æ—¥å¿—åˆ†ææŠ¥å‘Š'} - æ—¥å¿—åˆ†ææŠ¥å‘Š`;
            } catch (error) {
                showError(`åŠ è½½æŠ¥å‘Šæ•°æ®å¤±è´¥: ${error.message}`);
                throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©å¤–å±‚catchæ•è·
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            var container = document.getElementById('log-container');
            if (container) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">' + message + '</div>';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            try {
                if (!reportData) {
                    showError('æŠ¥å‘Šæ•°æ®æœªåŠ è½½æˆåŠŸ');
                    return;
                }
                
                // æ¸…ç©ºåŠ è½½æç¤º
                document.getElementById('log-container').innerHTML = '';
                
                // æ¸²æŸ“å¼‚å¸¸å¯¼èˆª
                renderAbnormalNav();
                
                // æ¸²æŸ“æ—¥å¿—å†…å®¹
                renderLogEntries();
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
            } catch (error) {
                showError('åˆå§‹åŒ–é¡µé¢å¤±è´¥: ' + error.message);
            }
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            try {
                // ä¾§è¾¹æ åˆ‡æ¢
                const sidebarHeader = document.querySelector('.sidebar-header');
                if (sidebarHeader) {
                    sidebarHeader.addEventListener('click', toggleSidebar);
                }
                
                // ç­›é€‰æŒ‰é’®
                const applyFilterBtn = document.getElementById('apply-filter-btn');
                if (applyFilterBtn) {
                    applyFilterBtn.addEventListener('click', applyFilter);
                }
                
                // é‡ç½®æŒ‰é’®
                const clearFilterBtn = document.getElementById('clear-filter-btn');
                if (clearFilterBtn) {
                    clearFilterBtn.addEventListener('click', clearFilter);
                }
                
                // æ’åºæŒ‰é’®
                const sortAscBtn = document.getElementById('sort-asc-btn');
                const sortDescBtn = document.getElementById('sort-desc-btn');
                if (sortAscBtn) {
                    sortAscBtn.addEventListener('click', () => sortLogs('asc'));
                }
                if (sortDescBtn) {
                    sortDescBtn.addEventListener('click', () => sortLogs('desc'));
                }
                
                // å¯¼å‡ºæŒ‰é’®
                const exportBtn = document.getElementById('export-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportPureReport);
                }
                
                // æœç´¢æ¡†Enteré”®äº‹ä»¶
                const filterInput = document.getElementById('filterInput');
                if (filterInput) {
                    filterInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            applyFilter();
                        }
                    });
                }
                
                // æ¶ˆæ¯ç±»å‹è¾“å…¥
                const msgTypeInput = document.getElementById('msgTypeInput');
                const msgTypeDropdown = document.getElementById('msgTypeDropdown');
                if (msgTypeInput && msgTypeDropdown) {
                    msgTypeInput.addEventListener('focus', () => {
                        renderDropdown(msgTypeInput.value);
                        msgTypeDropdown.style.display = 'block';
                    });
                    msgTypeInput.addEventListener('input', (e) => {
                        renderDropdown(e.target.value);
                        msgTypeDropdown.style.display = 'block';
                    });
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.msg-type-container')) {
                            msgTypeDropdown.style.display = 'none';
                        }
                    });
                }
            } catch (error) {
                console.error('ç»‘å®šäº‹ä»¶å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¼‚å¸¸å¯¼èˆª
        function renderAbnormalNav() {
            try {
                if (!reportData) return;
                
                const list = document.getElementById('sidebarContent');
                const badge = document.getElementById('sidebarBadge');
                // ç©ºå€¼ä¿æŠ¤ï¼šç¡®ä¿abnormal_itemsæ˜¯æ•°ç»„
                const abnormalItems = Array.isArray(reportData.abnormal_items) ? reportData.abnormal_items : [];
                
                // è®¾ç½®å¾½ç« 
                const count = abnormalItems.length;
                if (badge) {
                    badge.textContent = count;
                    badge.classList.toggle('zero', count === 0); // ç®€åŒ–classæ“ä½œ
                }
                
                // æ¸²æŸ“åˆ—è¡¨
                if (!list) return;
                
                if (count === 0) {
                    list.innerHTML = '<div class="ab-empty">ğŸ‰ æ— å¼‚å¸¸æŠ¥é”™</div>';
                    return;
                }
                
                let html = '';
                for (const item of abnormalItems) {
                    if (item) {
                        const detailsHtml = Array.isArray(item.details) ? item.details.map(detail => `<div class="ab-detail-row">${detail}</div>`).join('') : '';
                        html += `
                            <div class="abnormal-item" data-anchor="${item.anchor || ''}">
                                <span class="ab-time">${item.time || ''}</span>
                                <div style="font-weight:600; font-size:13px; margin-bottom:4px;">${item.msgType || 'æœªçŸ¥æŠ¥æ–‡'}</div>
                                ${detailsHtml}
                            </div>
                        `;
                    }
                }
                list.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const abnormalItemsList = list.querySelectorAll('.abnormal-item');
                abnormalItemsList.forEach(item => {
                    item.addEventListener('click', () => {
                        const anchor = item.getAttribute('data-anchor');
                        scrollToLog(anchor);
                    });
                });
            } catch (error) {
                console.error('æ¸²æŸ“å¼‚å¸¸å¯¼èˆªå¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æ—¥å¿—æ¡ç›®
        function renderLogEntries() {
            try {
                if (!reportData) return;
                
                const container = document.getElementById('log-container');
                if (!container) return;
                
                const logEntries = Array.isArray(reportData.log_entries) ? reportData.log_entries : [];
                let html = '';
                
                for (let index = 0; index < logEntries.length; index++) {
                    const item = logEntries[index];
                    if (item) {
                        html += renderLogEntry(item, index);
                    }
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('æ¸²æŸ“æ—¥å¿—æ¡ç›®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å•ä¸ªæ—¥å¿—æ¡ç›®
        function renderLogEntry(entry, index) {
            try {
                if (!entry) return '';
                
                const segments = entry.segments || [];
                const isTransaction = entry.requests && entry.response;
                let mainEntry = entry;
                let retryCount = 0;
                let hasResponse = false;
                
                if (isTransaction && Array.isArray(entry.requests)) {
                    mainEntry = entry.latest_request || entry;
                    retryCount = entry.requests.length - 1;
                    hasResponse = entry.response !== null && entry.response !== undefined;
                }
                
                const logId = `log_${index}`;
                const transGroupId = isTransaction ? `trans_${index}` : '';
                const transAttr = isTransaction ? `data-trans-group="${transGroupId}" onmouseover="highlightTransaction('${transGroupId}')" onmouseout="clearHighlight()"` : '';
                
                // æ¸²æŸ“æ—¥å¿—æ¡ç›®å†…å®¹
                const lineHtml = renderLineContent(mainEntry);
                
                let html = `
                    <div class="timestamp" id="ts_${index}" data-log-id="${logId}" data-timestamp="${entry.timestamp || 0}" ${transAttr}>
                        ${lineHtml}
                    </div>
                `;
                
                // æ¸²æŸ“é‡è¯•è¡Œ
                if (isTransaction && Array.isArray(entry.requests) && retryCount > 0) {
                    html += `<div id="retries_${logId}" style="display:none; margin-left: 20px; border-left: 2px solid #e5e7eb; padding-left: 8px;">`;
                    for (const req of entry.requests.slice(0, -1)) {
                        if (req) {
                            const reqHtml = renderLineContent(req);
                            html += `
                                <div class="timestamp" style="border:none; padding: 2px 0;">
                                    <span style="color:#9ca3af; margin-right:8px; font-size:12px;">â”œâ”€ é‡è¯•</span>
                                    ${reqHtml}
                                </div>
                            `;
                        }
                    }
                    html += `</div>`;
                }
                
                // æ¸²æŸ“å›å¤è¡Œ
                if (isTransaction && hasResponse && entry.response) {
                    const respHtml = renderLineContent(entry.response);
                    html += `
                        <div class="timestamp" id="ts_${index}_resp" data-timestamp="${entry.timestamp || 0}" ${transAttr} style="border-top:none; margin-top:-1px;">
                            <div class="resp-container">
                                <span class="tree-connector">â””â”€â”€</span>
                                <span class="badge-resp">å›å¤</span>
                                ${respHtml}
                            </div>
                        </div>
                    `;
                }
                
                return html;
            } catch (error) {
                console.error('æ¸²æŸ“å•ä¸ªæ—¥å¿—æ¡ç›®å¤±è´¥:', error);
                return '';
            }
        }

        // æ¸²æŸ“æ—¥å¿—è¡Œå†…å®¹
        function renderLineContent(entry) {
            try {
                if (!entry) return '';
                
                const segments = entry.segments || [];
                const blockMap = {'ts': '', 'dir': '', 'node': '', 'msg_type': '', 'ver': '', 'pid': ''};
                
                // è§£ææ®µä¿¡æ¯
                for (const s of segments) {
                    if (s && typeof s === 'object') {
                        const k = s.kind;
                        if (k && k in blockMap && !blockMap[k]) {
                            blockMap[k] = s.text || '';
                        }
                    }
                }
                
                // å¤„ç†æ—¶é—´æˆ³
                let tsDisplay = blockMap['ts'] || '&nbsp;';
                const tsVal = entry.timestamp;
                if (tsVal) {
                    if (typeof tsVal === 'string') {
                        tsDisplay = tsVal;
                    } else if (tsVal instanceof Date) {
                        tsDisplay = tsVal.toISOString().replace('T', ' ').substring(0, 23);
                    } else {
                        tsDisplay = String(tsVal);
                    }
                }
                
                const parts = [];
                const hasDir = Boolean(blockMap['dir']);
                
                // æ¸²æŸ“æ—¶é—´æˆ³
                parts.push(`<span class="seg-fixed seg-ts" style="background:#e3f2fd;color:#0c4a6e;">${tsDisplay}</span>`);
                
                if (hasDir) {
                    const dlow = blockMap['dir'].toLowerCase();
                    const bg_c = dlow.indexOf('output') !== -1 ? '#fee2e2' : '#d1fae5'; // Red/Green
                    parts.push(`<span class="seg-fixed seg-dir" style="background:${bg_c};color:#1b1f23;">${blockMap['dir']}</span>`);
                    parts.push(`<span class="seg-fixed seg-node-sm" style="background:#f3f4f6;">${blockMap['node']}</span>`);
                    parts.push('<span style="color:#9ca3af;margin:0 2px;">:</span>');
                    
                    // æ¸²æŸ“æ¶ˆæ¯ç±»å‹
                    let desc = '';
                    for (const s of segments) {
                        if (s && typeof s === 'object' && s.kind === 'msg_type') {
                            desc = s.description || '';
                            break;
                        }
                    }
                    const titleAttr = desc ? `title="${htmlEscape(desc || '')}"` : '';
                    parts.push(`<span class="seg-fixed seg-msgtype-sm seg-msgtype" ${titleAttr} style="background:#fff7ed;color:#9a3412;">${blockMap['msg_type']}</span>`);
                } else {
                    // è‡ªç”±æ ¼å¼æ—¥å¿—
                    if (blockMap['pid']) {
                        parts.push(`<span class="seg-fixed seg-pid" style="background:#fef3c7;">${blockMap['pid']}</span>`);
                    }
                    for (const s of segments) {
                        if (s && typeof s === 'object' && !blockMap[s.kind] && s.kind !== 'field') {
                            parts.push(`<span class="seg-free" style="background:#f3f4f6;">${s.text || ''}</span>`);
                        }
                    }
                }
                
                // æ¸²æŸ“å­—æ®µ
                if (hasDir) {
                    const palette = ['#e0f2fe', '#f0fdf4', '#ffedd5', '#f3e8ff', '#ecfeff'];
                    for (let idx = 0; idx < segments.length; idx++) {
                        const s = segments[idx];
                        if (s && typeof s === 'object' && s.kind === 'field') {
                            const bg = palette[idx % palette.length];
                            parts.push(`<span class="seg-free" style="background:${bg};color:#374151;">${s.text || ''}</span>`);
                        }
                    }
                }
                
                // æ·»åŠ å¼‚å¸¸æ ‡è®°
                if (entry.escape_hits && Array.isArray(entry.escape_hits) && entry.escape_hits.length > 0) {
                    parts.push(' <span class="tag-abnormal">å¼‚å¸¸æŠ¥é”™</span>');
                }
                
                return parts.join('');
            } catch (error) {
                console.error('æ¸²æŸ“æ—¥å¿—è¡Œå†…å®¹å¤±è´¥:', error);
                return '';
            }
        }

        // HTMLè½¬ä¹‰
        function htmlEscape(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('expanded');
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šæ—¥å¿—
        function scrollToLog(anchor) {
            const target = document.getElementById(anchor);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.classList.remove('flash-highlight');
                void target.offsetWidth; // trigger reflow
                target.classList.add('flash-highlight');
            }
        }

        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const qRaw = document.getElementById('filterInput').value.trim();
            let re = null;
            if (qRaw) {
                try {
                    re = new RegExp(qRaw.startsWith('/') ? qRaw.slice(1, qRaw.lastIndexOf('/')) : qRaw, 'i');
                } catch (e) {}
            }
            
            // å¤„ç†æ—¶é—´èŒƒå›´
            const sStr = document.getElementById('startTime').value;
            const eStr = document.getElementById('endTime').value;
            const sTime = sStr ? new Date(sStr).getTime() : null;
            const eTime = eStr ? new Date(eStr).getTime() : null;
            
            // ç­›é€‰æ—¥å¿—
            const rows = document.querySelectorAll('.timestamp');
            rows.forEach(r => {
                let show = true;
                if (re && !re.test(r.textContent)) {
                    show = false;
                }
                
                const ts = parseInt(r.getAttribute('data-timestamp') || 0, 10) || 0;
                if (show && ts > 0) {
                    if (sTime && ts < sTime) show = false;
                    if (eTime && ts > eTime) show = false;
                }
                
                if (show && selectedMsgTypes.size > 0) {
                    const mt = r.querySelector('.seg-msgtype');
                    if (!mt || !selectedMsgTypes.has(mt.textContent.trim())) {
                        show = false;
                    }
                }
                
                r.style.display = show ? 'flex' : 'none';
            });
        }

        // æ’åºæ—¥å¿—
        function sortLogs(order = 'asc') {
            const container = document.getElementById('log-container');
            if (!container) return;
            
            const rows = Array.from(container.querySelectorAll('.timestamp')).filter(r => r.id.startsWith('ts_'));
            rows.sort((a, b) => {
                // ç©ºå€¼ä¿æŠ¤ï¼šè½¬æ¢å¤±è´¥æ—¶è®¾ä¸º0
                const ta = parseInt(a.getAttribute('data-timestamp') || '0', 10) || 0;
                const tb = parseInt(b.getAttribute('data-timestamp') || '0', 10) || 0;
                return order === 'desc' ? (tb - ta) : (ta - tb);
            });
            
            const frag = document.createDocumentFragment();
            for (const row of rows) {
                frag.appendChild(row);
                const logId = row.getAttribute('data-log-id');
                const retries = logId ? document.getElementById(`retries_${logId}`) : null;
                if (retries) frag.appendChild(retries);
            }
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        // é‡ç½®ç­›é€‰
        function clearFilter() {
            document.getElementById('filterInput').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            selectedMsgTypes.clear();
            renderTags();
            applyFilter();
        }

        // æ¸²æŸ“æ¶ˆæ¯ç±»å‹ä¸‹æ‹‰åˆ—è¡¨
        function renderDropdown(filterText) {
            const dropdown = document.getElementById('msgTypeDropdown');
            if (!dropdown || !reportData) return;
            
            dropdown.innerHTML = '';
            const lower = (filterText || '').toLowerCase();
            // ç©ºå€¼ä¿æŠ¤ï¼šç¡®ä¿message_typesæ˜¯æ•°ç»„
            const allTypes = Array.isArray(reportData.message_types) ? reportData.message_types : [];
            const filtered = allTypes.filter(mt => 
                typeof mt === 'string' && 
                mt.toLowerCase().includes(lower) && 
                !selectedMsgTypes.has(mt)
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="msg-type-option" style="color:#9ca3af">æ— åŒ¹é…é¡¹</div>';
                return;
            }
            
            for (const mt of filtered) {
                const div = document.createElement('div');
                div.className = 'msg-type-option';
                div.textContent = mt;
                div.onclick = () => addMsgType(mt);
                dropdown.appendChild(div);
            }
        }

        // æ·»åŠ æ¶ˆæ¯ç±»å‹
        function addMsgType(mt) {
            selectedMsgTypes.add(mt);
            renderTags();
            document.getElementById('msgTypeInput').value = '';
            document.getElementById('msgTypeDropdown').style.display = 'none';
            applyFilter();
        }

        // ç§»é™¤æ¶ˆæ¯ç±»å‹
        function removeMsgType(mt) {
            selectedMsgTypes.delete(mt);
            renderTags();
            applyFilter();
        }

        // æ¸²æŸ“æ¶ˆæ¯ç±»å‹æ ‡ç­¾
        function renderTags() {
            const container = document.getElementById('selectedTags');
            if (!container) return;
            
            container.innerHTML = '';
            selectedMsgTypes.forEach(mt => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                
                const mtText = document.createTextNode(mt);
                tag.appendChild(mtText);
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'tag-remove';
                removeBtn.textContent = 'Ã—';
                removeBtn.addEventListener('click', () => removeMsgType(mt));
                tag.appendChild(removeBtn);
                
                container.appendChild(tag);
            });
        }

        // æŒ‚è½½åˆ°windowï¼Œè®©å†…è”äº‹ä»¶èƒ½è®¿é—®
        window.highlightTransaction = function(gid) {
            if (!gid) return;
            document.querySelectorAll(`[data-trans-group="${gid}"]`).forEach(el => {
                el.classList.add('trans-highlight');
            });
        }

        // æŒ‚è½½åˆ°windowï¼Œè®©å†…è”äº‹ä»¶èƒ½è®¿é—®
        window.clearHighlight = function() {
            document.querySelectorAll('.trans-highlight').forEach(el => {
                el.classList.remove('trans-highlight');
            });
        }

        // å¯¼å‡ºçº¯å‡€ç‰ˆæŠ¥å‘Š
        async function exportPureReport() {
            if (!reportData || !reportId) {
                showError('ç¼ºå°‘æŠ¥å‘Šæ•°æ®æˆ–æŠ¥å‘ŠID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/export-pure-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ report_id: reportId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // ä¸‹è½½æŠ¥å‘Š
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportData && reportData.name ? reportData.name : 'æŠ¥å‘Š'}_pure.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                showError(`å¯¼å‡ºæŠ¥å‘Šå¤±è´¥: ${error.message}`);
            }
        }
    </script>
    <style>
        /* Reset & Layout Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1f2937;
            height: 100vh; /* å…¨å±é«˜åº¦ */
            overflow: hidden; /* ç¦æ­¢ Body æ»šåŠ¨ï¼Œç”±å†…éƒ¨å®¹å™¨æ¥ç®¡ */
            display: flex;
        }

        /* =========================================
           Sidebar Styles (æ€§èƒ½ä¼˜åŒ–ç‰ˆ)
           ä¸å†ä½¿ç”¨ fixedï¼Œæ”¹ä¸º flex itemï¼Œé¿å…é‡æ’
        ========================================= */
        #sidebar {
            width: 60px; /* é»˜è®¤æŠ˜å å®½åº¦ */
            height: 100%;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        
        /* å±•å¼€çŠ¶æ€ç±» */
        #sidebar.expanded {
            width: 320px;
        }

        /* Sidebar Header (Toggle Area) */
        .sidebar-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center; /* æŠ˜å æ—¶å±…ä¸­ */
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            background: #f9fafb;
            transition: background 0.2s;
        }
        .sidebar-header:hover { background: #eff6ff; }
        #sidebar.expanded .sidebar-header {
            justify-content: flex-start;
            padding-left: 16px;
        }

        /* Sidebar Icon & Text */
        .icon-box {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .sb-title {
            display: none;
            font-weight: 700;
            color: #111827;
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
        }
        #sidebar.expanded .sb-title { display: block; }

        /* Badges */
        .count-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecdd3;
            font-size: 10px;
            font-weight: 700;
            height: 18px;
            min-width: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        .count-badge.zero { background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }

        /* Sidebar Content (Scrollable List) */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            opacity: 0; /* æŠ˜å æ—¶éšè—å†…å®¹ */
            pointer-events: none;
            transition: opacity 0.1s;
            padding: 12px;
        }
        #sidebar.expanded .sidebar-content {
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.2s 0.1s; /* å»¶è¿Ÿæ˜¾ç¤ºå†…å®¹ */
        }

        /* Abnormal Item Card */
        .abnormal-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #f43f5e; /* çº¢è‰²å·¦è¾¹æ¡†é†’ç›® */
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .abnormal-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border-color: #fecdd3; /* hover border */
        }
        .ab-time { font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px; }
        .ab-detail-row {
            font-size: 12px;
            color: #374151;
            font-family: 'JetBrains Mono', Consolas, monospace;
            background: #fdf2f8;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            word-break: break-all;
        }
        .ab-empty { text-align: center; color: #9ca3af; padding: 20px; font-size: 13px; }

        /* =========================================
           Main Content Area
        ========================================= */
        #main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Flexbox æº¢å‡ºä¿®å¤ */
            height: 100%;
        }

        /* Filter Bar (Sticky inside main wrapper) */
        #filterBar {
            flex-shrink: 0;
            background: #fff;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Log Scroll Container (Independent Scroll) */
        #log-container {
            flex: 1;
            overflow-y: auto; /* åªæœ‰è¿™ä¸ªåŒºåŸŸæ»šåŠ¨ */
            padding: 20px;
            scroll-behavior: smooth;
        }

        /* =========================================
           Existing Log Styles (Preserved)
        ========================================= */
        .timestamp {
            display: flex;
            align-items: center;
            padding: 6px 10px; /*ç¨å¾®ç´§å‡‘ä¸€ç‚¹*/
            margin: 2px 0;
            background-color: #ffffff;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid transparent; /* é¢„ç•™è¾¹æ¡†é˜²æŠ–åŠ¨ */
            flex-wrap: wrap;
            gap: 4px 8px;
        }
        .timestamp:hover { background-color: #f9fafb; border-color: #e5e7eb; }
        
        /* Segment Styles */
        .seg-fixed {
            display: inline-block;
            box-sizing: border-box;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 4px;
            vertical-align: middle;
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 12px;
            white-space: nowrap;
        }
        .seg-ts {
            width: 160px;
            font-weight: 500;
        }
        .seg-dir {
            width: 70px;
            text-align: center;
            font-weight: 600;
        }
        .seg-node-sm {
            width: 50px;
            text-align: center;
        }
        .seg-msgtype-sm {
            width: 110px;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .seg-pid {
            width: 130px;
            text-align: center;
        }
        .seg-free {
            display: inline-block;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* Filter Components */
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9fafb;
            padding: 4px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .filter-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
        }
        .crystal-input {
            border: none;
            background: transparent;
            font-size: 13px;
            outline: none;
            color: #1f2937;
        }
        
        /* Buttons */
        .btn {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .jump-btn {
            height: 22px;
            padding: 0 10px;
            border-radius: 11px;
            font-size: 11px;
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            margin-left: auto;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .jump-btn:hover {
            background: #2563eb;
            color: white;
        }

        /* Dropdown & Tags */
        .msg-type-container {
            position: relative;
        }
        .msg-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 280px;
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            padding: 4px;
            border-radius: 8px;
        }
        .msg-type-option {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
        }
        .msg-type-option:hover {
            background: #eff6ff;
            color: #1d4ed8;
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .tag {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
        }
        .tag-remove:hover {
            opacity: 1;
        }

        /* Highlighting */
        .flash-highlight {
            animation: flash-bg 2s ease-out forwards;
            border: 1px solid #ef4444 !important;
        }
        @keyframes flash-bg {
            0% { background: #fee2e2; }
            100% { background: #fff; }
        }
        .trans-highlight {
            background-color: #f0f9ff !important;
            border-left: 3px solid #3b82f6 !important;
        }

        /* Tree Structure */
        .badge-req {
            padding: 1px 4px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 6px;
            border: 1px solid #bfdbfe;
        }
        .badge-resp {
            padding: 1px 4px;
            background: #dcfce7;
            color: #166534;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 6px;
            border: 1px solid #bbf7d0;
        }
        .tree-connector {
            width: 20px;
            text-align: right;
            color: #9ca3af;
            margin-right: 4px;
            font-family: monospace;
            font-weight: bold;
        }
        .resp-container {
            display: flex;
            align-items: center;
        }
        .tag-abnormal {
            background: #fef2f2;
            border: 1px solid #fecdd3;
            color: #b91c1c;
            font-size: 11px;
            padding: 0 4px;
            border-radius: 3px;
            margin-left: 4px;
        }
        
        /* å¯¼å‡ºæŒ‰é’® */
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
        }
        .export-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header" title="ç‚¹å‡»å±•å¼€/æ”¶èµ·">
            <div class="icon-box">
                âš ï¸
                <div id="sidebarBadge" class="count-badge">0</div>
            </div>
            <span class="sb-title">å¼‚å¸¸æŠ¥é”™åˆ—è¡¨</span>
        </div>
        <div id="sidebarContent" class="sidebar-content">
        </div>
    </div>

    <div id="main-wrapper">
        <div id="filterBar">
            <div class="filter-group" style="flex: 1; min-width: 200px;">
                <span class="filter-label">ğŸ” æœç´¢</span>
                <input id="filterInput" class="crystal-input" style="width: 100%;" type="text" placeholder="æ­£åˆ™æ”¯æŒ..." />
            </div>
            <div class="filter-group">
                <span class="filter-label">ğŸ•’ æ—¶é—´</span>
                <input id="startTime" class="crystal-input" type="datetime-local" step="1" style="width:170px;" lang="zh-CN" />
                <span style="color:#ccc">-</span>
                <input id="endTime" class="crystal-input" type="datetime-local" step="1" style="width:170px;" lang="zh-CN" />
            </div>
            <div class="filter-group msg-type-container">
                <span class="filter-label">ğŸ·ï¸ æŠ¥æ–‡</span>
                <div class="selected-tags" id="selectedTags"></div>
                <input id="msgTypeInput" class="crystal-input" style="width: 100px;" placeholder="é€‰æ‹©ç±»å‹..." />
                <div id="msgTypeDropdown" class="msg-type-dropdown"></div>
            </div>
            <div class="filter-group" style="gap: 6px;">
                <span class="filter-label">æ’åº</span>
                <button class="btn" id="sort-asc-btn">æ—¶é—´æ­£åº</button>
                <button class="btn" id="sort-desc-btn">æ—¶é—´é€†åº</button>
            </div>
            <button class="btn btn-primary" id="apply-filter-btn">ç­›é€‰</button>
            <button class="btn" id="clear-filter-btn">é‡ç½®</button>
            <button class="btn export-btn" id="export-btn">å¯¼å‡ºçº¯å‡€ç‰ˆæŠ¥å‘Š</button>
        </div>

        <div id="log-container">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <h2>åŠ è½½ä¸­...</h2>
                <p>æ­£åœ¨åŠ è½½æŠ¥å‘Šæ•°æ®ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>
</body>
</html>