<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_data.name }} - æ·±åº¦åˆ†ææŠ¥å‘Š</title>
    <style>
        :root {
            /* ç°ä»£é…è‰² (Slate & Blue) */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #334155;
            --text-dim: #94a3b8;
            --border: #e2e8f0;
            --primary: #3b82f6;
            --primary-light: #eff6ff;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --success: #10b981;
            
            /* ä»£ç å—é…è‰² (Dark) */
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-main);
            background-color: var(--bg-body);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            min-height: 80vh;
        }

        /* === 1. å¤´éƒ¨åŒºåŸŸ (ç¾åŒ–ç‰ˆ) === */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 { margin: 0; font-size: 18px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 10px; }
        .badge-count { background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .header-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; font-family: monospace; }
        
        .btn-switch {
            padding: 6px 12px; border: 1px solid var(--border); background: #fff;
            border-radius: 6px; cursor: pointer; color: var(--text-main); font-weight: 500;
            transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-switch:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }

        /* === 2. å¼‚å¸¸æ¦‚è§ˆ (çº¢è‰²è­¦ç¤º) === */
        .abnormal-panel {
            background: var(--danger-bg);
            border-bottom: 1px solid #fee2e2;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .ab-title { font-weight: 700; color: #991b1b; display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .ab-tag {
            background: #fff; border: 1px solid #fecaca; color: #b91c1c;
            padding: 2px 8px; border-radius: 4px; cursor: pointer;
            font-size: 11px; font-family: monospace; transition: all 0.1s;
        }
        .ab-tag:hover { border-color: var(--danger); box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1); transform: translateY(-1px); }

        /* === 3. å·¥å…·æ  === */
        .toolbar {
            padding: 10px 24px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
        }
        #searchInput {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 13px; outline: none; transition: border-color 0.2s;
        }
        #searchInput:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        /* === 4. æ—¥å¿—åˆ—è¡¨ (Modern Grid) === */
        .log-list { display: flex; flex-direction: column; }

        .row {
            display: grid;
            /* å¸ƒå±€ï¼šæ—¶é—´(160px) | æ ‡ç­¾(è‡ªé€‚åº”) | å†…å®¹(å‰©ä½™) */
            grid-template-columns: 160px min-content 1fr;
            gap: 16px;
            padding: 8px 24px; /* èˆ’é€‚çš„é—´è· */
            border-bottom: 1px solid #f1f5f9;
            align-items: baseline;
            transition: background 0.2s;
        }
        .row:hover { background-color: #f8fafc; }
        
        /* æŠ¥é”™é«˜äº®åŠ¨ç”» (çº¢è‰²é—ªçƒ) */
        @keyframes errorFlash {
            0% { background-color: #fee2e2; border-left: 4px solid var(--danger); }
            100% { background-color: transparent; border-left: 4px solid transparent; }
        }
        .row.highlight-error { animation: errorFlash 3s ease-out forwards; }

        /* åˆ—æ ·å¼ */
        .col-ts { 
            font-family: 'JetBrains Mono', Consolas, monospace; 
            font-size: 12px; color: var(--text-dim); text-align: right; 
            white-space: nowrap; 
        }
        
        .col-meta { display: flex; gap: 6px; align-items: center; white-space: nowrap; }

        .col-content { 
            position: relative; word-break: break-all; 
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 12px; color: #1e293b;
        }

        /* èƒ¶å›Šæ ‡ç­¾ (Pills) */
        .pill { 
            display: inline-block; padding: 1px 6px; border-radius: 4px; 
            font-size: 11px; font-weight: 600; line-height: 1.4; border: 1px solid transparent;
        }
        .pill-in { background: #fef2f2; color: #991b1b; border-color: #fecaca; }
        .pill-out { background: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .pill-sys { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
        
        /* æ ¸å¿ƒå­—æ®µé«˜äº® */
        .f-val { 
            color: #0369a1; background: #e0f2fe; 
            padding: 1px 4px; border-radius: 3px; font-weight: 500;
            border: 1px solid #bae6fd;
        }

        /* === äº¤äº’æŒ‰é’® === */
        /* åŸæ–‡å¼€å…³ */
        .btn-raw {
            display: inline-block; cursor: pointer; user-select: none;
            font-size: 10px; color: #94a3b8; border: 1px solid #cbd5e1;
            padding: 0 4px; border-radius: 3px; margin-left: 8px;
            vertical-align: middle; height: 16px; line-height: 14px;
            background: #fff; transition: all 0.2s;
        }
        .btn-raw:hover { color: var(--primary); border-color: var(--primary); }
        .btn-raw.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* é‡è¯•å¼€å…³ */
        .btn-retry {
            cursor: pointer; color: var(--danger); font-weight: 600; font-size: 11px;
            margin-left: 12px; padding: 2px 6px; border-radius: 4px;
            transition: background 0.2s;
        }
        .btn-retry:hover { background: #fee2e2; }

        /* === å†…åµŒåŸæ–‡åŒºåŸŸ (Dark Mode) === */
        .raw-container {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 8px;
            background: var(--code-bg);
            border-radius: 6px;
            padding: 10px 12px;
            border-left: 3px solid var(--primary);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.2);
        }
        .raw-container.show { display: block; animation: slideDown 0.2s ease-out; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .raw-line {
            color: var(--code-text);
            font-family: Consolas, monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }
        .raw-l2 {
            color: #94a3b8; /* ç¬¬äºŒè¡Œæ›´æš— */
            border-top: 1px dashed #334155;
            margin-top: 6px; padding-top: 6px;
        }

        /* === é‡è¯•è¡Œ (ç¼©è¿›æ˜¾ç¤º) === */
        .retry-block { display: none; }
        .retry-block.show { display: block; }
        
        .row-retry {
            background-color: #f8fafc;
            padding-left: 40px; /* ç¼©è¿› */
            grid-template-columns: 140px min-content 1fr;
            border-bottom: 1px dashed #e2e8f0;
        }
        .row-retry .col-ts, .row-retry .col-content { opacity: 0.75; }
        .retry-label { font-size: 11px; font-weight: 700; color: var(--text-dim); letter-spacing: 1px; }

        /* å“åº”è¡Œç‰¹æ®Šæ ·å¼ */
        .row-resp { border-left: 3px solid var(--success); padding-left: 21px; background-color: #f0fdfa; }

        /* === è§†å›¾åˆ‡æ¢ === */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* çº¯æ–‡æœ¬è§†å›¾ (ä¿®å¤æ ¼å¼é—®é¢˜) */
        #view-raw {
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: auto;
            min-height: 80vh;
            font-family: Consolas, monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre; /* ä¸¥æ ¼ä¿ç•™æ ¼å¼ */
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>
                    {{ report_data.name }}
                    <span class="badge-count">{{ report_data.log_entries | length }} Logs</span>
                </h1>
                <div class="header-meta">
                    {{ report_data.factory }} / {{ report_data.system }} | 
                    {{ report_data.generated_at }} | 
                    Nodes: {{ report_data.nodes | join(', ') }}
                </div>
            </div>
            <button class="btn-switch" onclick="toggleView()" id="btnView">ğŸ“„ åˆ‡æ¢åŸæ–‡æ¨¡å¼</button>
        </div>

        {% if report_data.abnormal_items %}
        <div class="abnormal-panel" id="abPanel">
            <div class="ab-title">âš ï¸ å‘ç° {{ report_data.abnormal_items | length }} ä¸ªå¼‚å¸¸ç‚¹:</div>
            <div class="ab-list">
                {% for item in report_data.abnormal_items %}
                <div class="ab-tag" onclick="scrollToId('row_{{ item.anchor }}')">
                    [{{ item.time }}] {{ item.msgType }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div id="view-parsed" class="view-section active">
            <div class="toolbar">
                <input type="text" id="searchInput" placeholder="Type to filter logs..." onkeyup="filterLogs()">
            </div>

            <div class="log-list">
                {% for entry in report_data.log_entries %}
                    {% set is_trans = entry.requests is defined and entry.response is defined %}
                    
                    {# ä¸»æ—¥å¿— #}
                    {% set main = entry.latest_request if is_trans else entry %}
                    {% set retry_cnt = (entry.requests | length - 1) if is_trans else 0 %}
                    {# ID è§„åˆ™: row_ + åŸå§‹é”šç‚¹ID (é€šå¸¸æ˜¯ ts_0, ts_1) #}
                    {% set row_id = "row_ts_" ~ loop.index0 %}
                    
                    <div class="row" id="{{ row_id }}" data-text="{{ main.segments | map(attribute='text') | join(' ') | lower }}">
                        <div class="col-ts">{{ main.timestamp }}</div>
                        
                        <div class="col-meta">
                            {% for seg in main.segments %}
                                {% if seg.kind == 'dir' %}
                                    <span class="pill {{ 'pill-out' if 'Output' in seg.text else 'pill-in' }}">{{ seg.text }}</span>
                                {% elif seg.kind == 'node' %}
                                    <span class="pill pill-sys">{{ seg.text }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <div class="col-content">
                            {% for seg in main.segments %}{% if seg.kind == 'msg_type' %}
                                <span style="font-weight:600; color:#d97706; margin-right:6px;">{{ seg.text }}</span>
                            {% endif %}{% endfor %}

                            {% if is_trans %}<span style="color:var(--primary); font-weight:bold; margin-right:6px;">â†’</span>{% endif %}
                            
                            {% for seg in main.segments %}
                                {% if seg.kind == 'field' %}
                                    <span class="f-val">{{ seg.text }}</span>
                                {% elif seg.kind not in ['ts', 'dir', 'node', 'msg_type'] %}
                                    <span>{{ seg.text }}</span>
                                {% endif %}
                            {% endfor %}

                            {% if main.escape_hits %}
                                <span style="background:var(--danger); color:#fff; padding:1px 4px; border-radius:3px; font-weight:bold; font-size:10px; margin-left:6px;">ERR</span>
                            {% endif %}
                            
                            <span class="btn-raw" onclick="toggleRaw(this)">RAW</span>
                            
                            {% if retry_cnt > 0 %}
                                <span class="btn-retry" onclick="toggleRetry('rg_{{ loop.index0 }}')">
                                    â†º {{ retry_cnt }} é‡è¯•
                                </span>
                            {% endif %}

                            <div class="raw-container">
                                <div class="raw-line">{{ main.original_line1 }}</div>
                                {% if main.original_line2 %}<div class="raw-line raw-l2">{{ main.original_line2 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    {# é‡è¯•ç»„ #}
                    {% if is_trans and retry_cnt > 0 %}
                    <div id="rg_{{ loop.index0 }}" class="retry-block">
                        {% for req in entry.requests[:-1] %}
                        <div class="row row-retry" data-text="{{ req.segments | map(attribute='text') | join(' ') | lower }}">
                            <div class="col-ts">{{ req.timestamp }}</div>
                            <div class="col-meta retry-label">RETRY</div>
                            <div class="col-content">
                                {% for seg in req.segments %}
                                    {% if seg.kind == 'field' %}<span style="background:#f1f5f9; color:#64748b; padding:0 3px; border-radius:2px;">{{ seg.text }}</span>{% endif %}
                                {% endfor %}
                                
                                <span class="btn-raw" onclick="toggleRaw(this)">RAW</span>
                                <div class="raw-container">
                                    <div class="raw-line">{{ req.original_line1 }}</div>
                                    {% if req.original_line2 %}<div class="raw-line raw-l2">{{ req.original_line2 }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# å“åº”è¡Œ #}
                    {% if is_trans and entry.response %}
                    <div class="row row-resp" data-text="{{ entry.response.segments | map(attribute='text') | join(' ') | lower }}">
                        <div class="col-ts">{{ entry.response.timestamp }}</div>
                        <div class="col-meta">
                            <span class="pill pill-out">RESP</span>
                        </div>
                        <div class="col-content">
                            <span style="color:var(--success); font-weight:bold; margin-right:6px;">â†</span>
                            {% for seg in entry.response.segments %}
                                {% if seg.kind == 'field' %}
                                    <span class="f-val" style="background:#dcfce7; color:#166534; border-color:#bbf7d0;">{{ seg.text }}</span>
                                {% elif seg.kind not in ['ts', 'dir', 'node', 'msg_type'] %}
                                    <span>{{ seg.text }}</span>
                                {% endif %}
                            {% endfor %}
                            
                            <span class="btn-raw" onclick="toggleRaw(this)">RAW</span>
                            <div class="raw-container">
                                <div class="raw-line">{{ entry.response.original_line1 }}</div>
                                {% if entry.response.original_line2 %}<div class="raw-line raw-l2">{{ entry.response.original_line2 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                {% endfor %}
            </div>
        </div>

        <div id="view-raw" class="view-section">
            <pre class="full-raw-text">
{%- for entry in report_data.log_entries -%}
{%- set is_trans = entry.requests is defined and entry.response is defined -%}
{%- if is_trans -%}
{%- for req in entry.requests -%}
{{ req.original_line1 }}{{ '\n' if req.original_line2 }}{{ req.original_line2 }}{{ '\n' }}
{%- endfor -%}
{%- if entry.response -%}
{{ entry.response.original_line1 }}{{ '\n' if entry.response.original_line2 }}{{ entry.response.original_line2 }}{{ '\n' }}
{%- endif -%}
{%- else -%}
{{ entry.original_line1 }}{{ '\n' if entry.original_line2 }}{{ entry.original_line2 }}{{ '\n' }}
{%- endif -%}
{%- endfor -%}
</pre>
        </div>

    </div>

    <script>
        // æœç´¢
        function filterLogs() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.row[data-text]');
            
            rows.forEach(row => {
                const txt = row.getAttribute('data-text') || '';
                if (txt.includes(input)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        // è·³è½¬ä¿®å¤
        function scrollToId(id) {
            // å…¼å®¹æ€§å¤„ç†
            let el = document.getElementById(id);
            if (!el && id.startsWith('row_ts_')) {
               // æœ‰äº›æ—¶å€™ anchor å¯èƒ½åªæ˜¯æ•°å­—ç´¢å¼•
               // æˆ‘ä»¬çš„ ID æ ¼å¼æ˜¯ row_ts_0
            } else if (!el) {
                // å°è¯•å®¹é”™
                el = document.getElementById('row_' + id) || document.getElementById(id.replace('ts_', 'row_ts_'));
            }

            if (el) {
                // ç¡®ä¿åœ¨è§£æè§†å›¾
                const vParsed = document.getElementById('view-parsed');
                if (vParsed.style.display === 'none') toggleView();

                el.scrollIntoView({behavior: 'smooth', block: 'center'});
                // çº¢è‰²é«˜äº®
                document.querySelectorAll('.highlight-error').forEach(e => e.classList.remove('highlight-error'));
                el.classList.add('highlight-error');
            } else {
                console.warn('Target ID not found:', id);
            }
        }

        // ä¿®å¤ï¼šä½¿ç”¨ closest ç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„ raw-container
        function toggleRaw(btn) {
            // åœ¨åŒçº§æ‰¾
            let container = btn.parentNode.querySelector('.raw-container');
            if (container) {
                container.classList.toggle('show');
                btn.classList.toggle('active');
            }
        }

        function toggleRetry(id) {
            const group = document.getElementById(id);
            if (group) group.classList.toggle('show');
        }

        function toggleView() {
            const vParsed = document.getElementById('view-parsed');
            const vRaw = document.getElementById('view-raw');
            const btn = document.getElementById('btnView');
            const abPanel = document.getElementById('abPanel');
            const toolbar = document.querySelector('.toolbar');
            
            if (vRaw.style.display === 'block') {
                vRaw.style.display = 'none';
                vParsed.style.display = 'block';
                if(abPanel) abPanel.style.display = 'flex';
                toolbar.style.display = 'block';
                btn.innerText = 'ğŸ“„ åˆ‡æ¢åŸæ–‡æ¨¡å¼';
            } else {
                vRaw.style.display = 'block';
                vParsed.style.display = 'none';
                if(abPanel) abPanel.style.display = 'none';
                toolbar.style.display = 'none';
                btn.innerText = 'ğŸ”™ è¿”å›è§£ææ¨¡å¼';
            }
        }
        
        document.getElementById('searchInput').focus();
    </script>
</body>
</html>