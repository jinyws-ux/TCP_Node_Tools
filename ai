import os
import requests
import json
import base64
import pyaudio
import wave
import urllib3
import re
from openai import OpenAI
import pygame
import time

# ç¦ç”¨ SSL è­¦å‘Šï¼ˆå› ä¸ºä½ çš„æˆªå›¾ä»£ç é‡Œç”¨äº† verify=Falseï¼‰
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ================= é…ç½®åŒºåŸŸ =================
ACCESS_CODE = "YOUR_ACCESS_CODE_HERE"  # <--- è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Token
TEMP_AUDIO_DIR = "./temp_audio"

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
if not os.path.exists(TEMP_AUDIO_DIR):
    os.makedirs(TEMP_AUDIO_DIR)

# åˆå§‹åŒ– Pygame ç”¨äºæ’­æ”¾éŸ³é¢‘
pygame.mixer.init()

# ================= 1. è¯­éŸ³è¯†åˆ« (ASR) æ¨¡å— =================
def stt_service(audio_file_path):
    """è°ƒç”¨ AI Studio çš„ ASR æ¥å£"""
    url = f'https://aistudio.bmwbrill.cn/api/service/49/{ACCESS_CODE}/asr?task=transcribe'
    
    print(">>> æ­£åœ¨è¯†åˆ«è¯­éŸ³...")
    try:
        with open(audio_file_path, 'rb') as audio_file:
            files = {
                'audio_file': (os.path.basename(audio_file_path), audio_file, 'audio/wav')
            }
            headers = {'accept': 'text/plain'}
            # ä½ çš„ç¯å¢ƒæ˜¯å†…ç½‘ï¼Œå¯èƒ½éœ€è¦ verify=False
            response = requests.post(url, headers=headers, files=files, verify=False)
            
        if response.status_code == 200:
            text = response.text.strip()
            print(f"è¯†åˆ«ç»“æœ: {text}")
            return text
        else:
            print(f"ASR Error: {response.status_code} - {response.text}")
            return None
    except Exception as e:
        print(f"ASR Exception: {e}")
        return None

# ================= 2. è¯­éŸ³åˆæˆ (TTS) æ¨¡å— =================
def tts_service(text, index):
    """è°ƒç”¨ AI Studio çš„ TTS æ¥å£"""
    url = f'https://aistudio.bmwbrill.cn/api/service/66/{ACCESS_CODE}/createRec'
    
    payload = json.dumps({
        "endFlag": True,
        "sessionParam": {
            "native_voice_name": "xiaoyan", # ä½ æˆªå›¾é‡Œçš„å‚æ•°
            "sid": "zmigfpbts",
            "speed": "100",
            "volume": "0",
            "pitch": "100",
            "read_number": "0",
            "read_english": "2"
        },
        "text": text
    })
    headers = {'Content-Type': 'application/json'}
    
    try:
        response = requests.post(url, headers=headers, data=payload, verify=False)
        response_json = response.json()
        
        # è§£æ Base64 æ•°æ®
        if "resultlist" in response_json and len(response_json["resultlist"]) > 0:
            data_value = response_json["resultlist"][0]["data"]
            audio_data = base64.b64decode(data_value)
            
            # ä¿å­˜ä¸ºä¸´æ—¶æ–‡ä»¶
            filename = os.path.join(TEMP_AUDIO_DIR, f"reply_{index}.mp3")
            with open(filename, 'wb') as f:
                f.write(audio_data)
            return filename
        else:
            print(f"TTS Error: {response_json}")
            return None
    except Exception as e:
        print(f"TTS Exception: {e}")
        return None

def play_audio(file_path):
    """æ’­æ”¾éŸ³é¢‘æ–‡ä»¶"""
    if not file_path: return
    try:
        # å¿…é¡»é‡æ–°åŠ è½½ mixer ä»¥é¿å…å ç”¨æ–‡ä»¶
        pygame.mixer.music.load(file_path)
        pygame.mixer.music.play()
        while pygame.mixer.music.get_busy():
            pygame.time.Clock().tick(10)
    except Exception as e:
        print(f"Play Error: {e}")

# ================= 3. å½•éŸ³æ¨¡å— =================
def record_audio(output_filename):
    """ç®€å•çš„æŒ‰å›è½¦å½•éŸ³é€»è¾‘"""
    CHUNK = 1024
    FORMAT = pyaudio.paInt16
    CHANNELS = 1
    RATE = 16000 # æ¨è 16k é‡‡æ ·ç‡ç”¨äº ASR
    
    p = pyaudio.PyAudio()
    stream = p.open(format=FORMAT, channels=CHANNELS, rate=RATE, input=True, frames_per_buffer=CHUNK)
    
    print("\næŒ‰ä½ [Enter] é”®å¼€å§‹å½•éŸ³ï¼Œæ¾å¼€ç»“æŸ (æˆ–è€…ç®€å•çš„ï¼šæŒ‰å›è½¦å¼€å§‹ï¼Œå†æŒ‰å›è½¦ç»“æŸ)...")
    input(">>> æŒ‰å›è½¦é”®å¼€å§‹å½•éŸ³...")
    print("ğŸ”´ æ­£åœ¨å½•éŸ³... (å†æ¬¡æŒ‰å›è½¦åœæ­¢)")
    
    frames = []
    # è¿™é‡Œåšä¸€ä¸ªç®€å•çš„éé˜»å¡å½•éŸ³æ¨¡æ‹Ÿï¼Œå®é™…å¯èƒ½éœ€è¦å¤šçº¿ç¨‹æˆ–æ£€æµ‹é™éŸ³
    # ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œè¿™é‡Œè®¾å®šå½•éŸ³æœ€é•¿ 10 ç§’ï¼Œæˆ–è€…ä½ å¯ä»¥å¼ºåˆ¶ç”¨ Ctrl+C
    # ** æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨éé˜»å¡è¾“å…¥ï¼Œä½† Python æ ‡å‡†åº“åšè¿™ä¸ªæ¯”è¾ƒéº»çƒ¦ **
    # ** è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ï¼šå½•éŸ³ 5 ç§’è‡ªåŠ¨åœæ­¢çš„ç®€å•é€»è¾‘ä½œä¸ºæµ‹è¯•ï¼Œæˆ–è€…ä½¿ç”¨ VAD **
    
    # ä¸´æ—¶æ”¹ä¸ºï¼šå½•åˆ¶å›ºå®šæ—¶é•¿ç”¨äºæµ‹è¯•ï¼Œæˆ–è€…ä½ å¯ä»¥é›†æˆé”®ç›˜ç›‘å¬åº“ keyboard
    for i in range(0, int(RATE / CHUNK * 5)): # å½•éŸ³ 5 ç§’
        data = stream.read(CHUNK)
        frames.append(data)
        if i % 10 == 0: print(".", end="", flush=True)
    
    print("\nâ¹ï¸ å½•éŸ³ç»“æŸ")
    
    stream.stop_stream()
    stream.close()
    p.terminate()
    
    wf = wave.open(output_filename, 'wb')
    wf.setnchannels(CHANNELS)
    wf.setsampwidth(p.get_sample_size(FORMAT))
    wf.setframerate(RATE)
    wf.writeframes(b''.join(frames))
    wf.close()
    return output_filename

# ================= 4. ä¸»é€»è¾‘ (DeepSeek æµå¼å¤„ç†) =================
def chat_loop():
    # åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ (é€‚é… DeepSeek)
    client = OpenAI(
        api_key=f'ACCESSCODE {ACCESS_CODE}',
        base_url=f'https://aistudio.bmwbrill.cn/function-service/open-ai/deepseek-v3-0324/v3',
        http_client=requests.Session() # ä½¿ç”¨ requests session ä»¥æ”¯æŒ verify=False (å¦‚æœéœ€è¦æ·±åº¦å®šåˆ¶)
    )
    # Monkey patch for verify=False because openai lib validates SSL by default
    client._client.verify = False 

    history = []
    print("\n********** è¯­éŸ³åŠ©æ‰‹å·²å¯åŠ¨ **********")
    
    while True:
        # 1. å½•éŸ³
        audio_path = os.path.join(TEMP_AUDIO_DIR, "user_input.wav")
        record_audio(audio_path)
        
        # 2. è¯†åˆ«
        user_text = stt_service(audio_path)
        if not user_text:
            print("æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•ã€‚")
            continue
            
        history.append({"role": "user", "content": user_text})
        
        # 3. å‘é€ç»™ DeepSeek å¹¶æµå¼å¤„ç† TTS
        print(">>> æ€è€ƒä¸­...")
        
        response = client.chat.completions.create(
            model="DeepSeek-V3-0324",
            messages=history,
            stream=True
        )
        
        full_response_text = ""
        sentence_buffer = ""
        sentence_count = 0
        
        print("AI: ", end="")
        
        # æµå¼è¯»å–
        for chunk in response:
            if chunk.choices[0].delta.content:
                token = chunk.choices[0].delta.content
                print(token, end="", flush=True)
                full_response_text += token
                sentence_buffer += token
                
                # ç®€å•æ–­å¥é€»è¾‘ï¼šé‡åˆ°æ ‡ç‚¹ç¬¦å·å°±å»åˆæˆ
                if token in ["ï¼Œ", "ã€‚", "ï¼Ÿ", "ï¼", ",", ".", "?", "!", "\n"]:
                    # åªæœ‰ç¼“å†²åŒºæœ‰ä¸€å®šé•¿åº¦æ‰åˆæˆï¼Œé¿å…é¢‘ç¹è°ƒç”¨
                    if len(sentence_buffer) > 2:
                        sentence_count += 1
                        audio_file = tts_service(sentence_buffer, sentence_count)
                        if audio_file:
                            play_audio(audio_file)
                        sentence_buffer = "" # æ¸…ç©ºç¼“å†²
        
        # å¤„ç†å‰©ä½™çš„ç¼“å†²åŒº
        if sentence_buffer:
            sentence_count += 1
            audio_file = tts_service(sentence_buffer, sentence_count)
            play_audio(audio_file)
            
        print("\n")
        history.append({"role": "assistant", "content": full_response_text})

if __name__ == "__main__":
    chat_loop()
