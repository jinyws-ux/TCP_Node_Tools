def stt_service(audio_file_path):
    """
    调用新的 ASR 接口 (Service 65)
    流程：上传音频 -> 获取 OrderID -> 查询结果 -> 解析拼接文字
    """
    # 1. 定义接口地址
    base_url = "https://aistudio.bmwbrill.cn/api/service/65"
    upload_url = f"{base_url}/{ACCESS_CODE}/v1/upload"
    result_url = f"{base_url}/{ACCESS_CODE}/v1/getResult"
    
    filename = os.path.basename(audio_file_path)
    
    print(">>> [ASR] 正在上传语音...")
    
    # --- 第一步：上传音频 ---
    try:
        # 注意：新接口要求 binary 传输，Content-Type 为 octet-stream
        with open(audio_file_path, 'rb') as f:
            audio_data = f.read()
            
        headers = {
            'Content-Type': 'application/octet-stream',
            'accept': 'application/json'
        }
        
        # URL 参数带上文件名
        upload_params = {'fileName': filename}
        
        response = requests.post(upload_url, params=upload_params, data=audio_data, headers=headers, verify=False)
        
        if response.status_code != 200:
            print(f"[ASR] 上传失败: {response.status_code} - {response.text}")
            return None
            
        resp_json = response.json()
        if resp_json.get("code") != "000000":
            print(f"[ASR] API报错: {resp_json.get('descInfo')}")
            return None
            
        # 获取订单号
        order_id = resp_json["content"]["orderId"]
        print(f">>> [ASR] 获取订单号: {order_id}，正在获取结果...")
        
    except Exception as e:
        print(f"[ASR] 上传异常: {e}")
        return None

    # --- 第二步：轮询/查询结果 ---
    # 因为是异步的，可能需要稍微等一下，或者查几次（这里简单处理，先查一次，不行再循环）
    for i in range(5): # 最多试 5 次
        time.sleep(0.5) # 稍微等0.5秒让服务器处理
        try:
            params = {'orderId': order_id}
            headers = {'accept': 'application/json'}
            
            res_response = requests.get(result_url, params=params, headers=headers, verify=False)
            res_json = res_response.json()
            
            # 检查是否成功
            # 根据截图，content 里有 orderInfo，status=2 代表完成
            content = res_json.get("content", {})
            order_info = content.get("orderInfo", {})
            
            if order_info.get("status") == 2: # 2 代表成功
                # --- 第三步：解析复杂的 JSON 结果 ---
                # 结果在 content -> orderResult，这是一个字符串，需要再 json.loads 一次
                raw_result_str = content.get("orderResult", "[]")
                try:
                    segments = json.loads(raw_result_str)
                    
                    full_text = ""
                    # 遍历每一个片段
                    for segment in segments:
                        # 遍历片段里的 'cw' (content words)
                        if "cw" in segment:
                            for word_info in segment["cw"]:
                                if "w" in word_info:
                                    full_text += word_info["w"]
                    
                    print(f"识别结果: {full_text}")
                    return full_text
                    
                except Exception as parse_e:
                    print(f"[ASR] 解析结果JSON失败: {parse_e}")
                    return None
            else:
                # 还没处理完，继续循环
                print(f"[ASR] 处理中... (status: {order_info.get('status')})")
                continue
                
        except Exception as e:
            print(f"[ASR] 查询异常: {e}")
            break
            
    print("[ASR] 识别超时或失败")
    return None
